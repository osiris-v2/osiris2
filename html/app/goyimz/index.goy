<?php
function makecard($params = []) {
    $defaults = [
        "title"       => "Mi Sitio Web",
        "description" => "Bienvenido a mi p치gina personal.",
        "image"       => "https://tusitio.com/default-image.jpg",
        "url"         => (isset($_SERVER['HTTPS']) ? "https" : "http") . "://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]",
        "site_name"   => "Mi Marca",
        "twitter_id"  => "@tu_usuario",
        "card_type"   => "summary_large_image"
    ];
    $card = array_merge($defaults, $params);
    $html = "\n";
    $html .= '<meta property="og:type" content="website">' . "\n";
    $html .= '<meta property="og:url" content="' . htmlspecialchars($card['url']) . '">' . "\n";
    $html .= '<meta property="og:title" content="' . htmlspecialchars($card['title']) . '">' . "\n";
    $html .= '<meta property="og:description" content="' . htmlspecialchars($card['description']) . '">' . "\n";
    $html .= '<meta property="og:image" content="' . htmlspecialchars($card['image']) . '">' . "\n";
    $html .= '<meta property="og:site_name" content="' . htmlspecialchars($card['site_name']) . '">' . "\n";
    $html .= '<meta name="twitter:card" content="' . htmlspecialchars($card['card_type']) . '">' . "\n";
    $html .= '<meta name="twitter:title" content="' . htmlspecialchars($card['title']) . '">' . "\n";
    $html .= '<meta name="twitter:description" content="' . htmlspecialchars($card['description']) . '">' . "\n";
    $html .= '<meta name="twitter:image" content="' . htmlspecialchars($card['image']) . '">' . "\n";
    return $html;
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <?php 
    echo makecard([
        "title" => "Goyim Nation of Goys",
        "description" => "Goym World United",
        "image" => "https://goyimz.duckdns.org/img/goyimzh.png"
    ]);
    ?>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<style>
    /* Bloqueamos el scroll del body para que no "baile" en m칩viles */
    html, body { 
        height: 100%; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        background: #000000; 
        color: #0f0; 
        font-family: 'Courier New', monospace; 
    }

    /* El wrapper ahora ocupa todo el alto disponible */
    body { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }

    #wrapper { 
        width: 95%; 
        max-width: 640px; 
        height: 100vh; /* 100% del alto de la pantalla */
        display: flex; 
        flex-direction: column; 
        padding: 5px 0;
        text-align: center;
    }
    
    /* Cabecera fija */
    .header-img { display: block; max-width: 100%; max-height: 30px; margin: 0 auto 2px auto; flex-shrink: 0; }
    
    .view-modes { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 5px; flex-shrink: 0; }
    .mode-btn { background: none; border: 1px solid #333; color: #555; font-size: 0.7em; cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: 0.3s; }
    .mode-btn:hover { color: #0f0; border-color: #0f0; }
    .mode-btn.active { color: #0f0; border-color: #0f0; background: #052505; }

    /* EL CHAT: R칤gido para forzar scroll interno */
    #chat-box { 
        background: #0a0a0a; 
        border: 1px solid #333; 
        flex: 1 1 0; /* Crece para ocupar el espacio pero con base 0 */
        min-height: 0; /* Evita que el contenido empuje el alto del contenedor */
        overflow-y: auto; 
        padding: 10px; 
        margin-bottom: 5px; 
        text-align: left; 
        border-radius: 5px; 
    }
    
    /* Mensajes y enlaces (Tus estilos originales) */
    .msg { margin-bottom: 8px; border-bottom: 1px dashed #111; padding-bottom: 4px; white-space: pre-wrap; word-wrap: break-word; }
    .msg a { color: #ffff00; text-decoration: underline; font-weight: bold; }
    .msg a:hover { color: #fff; background: #444000; }
    .server { color: #0f0; }
    .user { color: #ccc; }
    .sys { color: #555; font-size: 0.8em; }

    /* Formulario y Botones siempre abajo */
    #chat-form { display: flex; gap: 5px; flex-shrink: 0; }
    input { flex-grow: 1; background: #111; border: 1px solid #333; color: #0f0; padding: 10px; font-family: inherit; }
    button#send-btn { background: #0f0; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }

    /* Drawer de Comandos fijo abajo */
    #command-drawer { width: 100%; margin-top: 5px; flex-shrink: 0; padding-bottom: 5px; }
    .drawer-btn { background: none; border: 1px solid #222; color: #444; font-size: 0.7em; cursor: pointer; padding: 4px; width: 100%; border-radius: 3px; }
    #quick-commands { display: none; flex-wrap: wrap; gap: 5px; padding: 10px; background: #050505; border: 1px solid #222; margin-top: -1px; }
    #quick-commands button { background: #111; border: 1px solid #333; color: #0c0; font-size: 0.75em; padding: 4px 8px; cursor: pointer; }
    #quick-commands button:hover { background: #0f0; color: #000; }
    .show { display: flex !important; }

    /* Estilos Servidores */
    .server-line { display: flex; align-items: center; justify-content: space-between; background: #080808; padding: 5px; margin: 2px 0; border-left: 2px solid #0f0; }
    .server-url { font-weight: bold; flex-grow: 1; font-size: 0.85em; }
    .server-info { font-size: 0.7em; color: #555; margin-right: 10px; }
    .server-actions { display: flex; gap: 5px; }
    .srv-btn { background: #000; border: 1px solid #0f0; color: #0f0; font-size: 0.65em; padding: 2px 5px; cursor: pointer; border-radius: 2px; }
    .srv-btn:hover { background: #0f0; color: #000; }
    .srv-btn.ping-btn { border-color: #ffff00; color: #ffff00; }
</style>
    
</head>

<body>
<div id="wrapper">
    <img src="img/goyimzh.png" class="header-img">  
    <div class="view-modes">
        <button class="mode-btn active" onclick="setMode('text', this)">TEXT</button>
        <button class="mode-btn" onclick="setMode('md', this)">MD</button>
        <button class="mode-btn" onclick="setMode('html', this)">HTML</button>
    </div>

    <div id="chat-box"></div>

    <form id="chat-form" onsubmit="enviarMensaje(event); return false;">
        <input type="text" id="message-input" placeholder="Comando..." required autocomplete="off">
        <button type="submit" id="send-btn">></button>
    </form>

    <div id="command-drawer">
        <button class="drawer-btn" onclick="toggleDrawer()">[+] COMANDOS R츼PIDOS</button>
        <div id="quick-commands">
            <button onclick="cmdRapido('/help')">/help</button>
            <button onclick="cmdRapido('/listtv')">/listtv</button>
            <button onclick="cmdRapido('/servers')">/servers</button>
            <button onclick="cmdRapido('/date')">/date</button>
            <button onclick="cmdRapido('/way')">/way</button>
            <button onclick="cmdRapido('/models')">/models</button>
            <button onclick="cmdRapido('/limit')">/limit</button>
            <button onclick="cmdRapido('/stop')">/stop</button>
            <button onclick="cmdRapido('/clearcontext')">/clearcontext</button>
        </div>
    </div>
</div>
<script type="text/javascript">
    let socket;
    let currentMode = 'text';
    let history = []; 
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    
    // VARIABLES DE ESTADO DE CONEXI칍N
    let activeHost = window.location.hostname; // El host por defecto al iniciar
    let reconnectInterval = 3000;
    let reconnectTimer = null;
    let lastServerMsgDiv = null;
    let lastCommandSent = ""; 

    marked.use({
        renderer: {
            link(href, title, text) {
                return `<a target="_blank" href="${href}">${text}</a>`;
            }
        }
    });

    function toggleDrawer() {
        document.getElementById('quick-commands').classList.toggle('show');
    }

    function cmdRapido(cmd) {
        messageInput.value = cmd;
        enviarMensaje();
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        refreshChat();
    }

    function refreshChat() {
        chatBox.innerHTML = "";
        history.forEach(m => renderToDOM(m.text, m.type));
    }

    // --- L칍GICA DE SERVIDORES CORREGIDA ---
    function isURL(str) {
        // Regex mejorada para detectar dominios en la lista de /servers
        const pattern = /[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}/;
        return pattern.test(str.trim());
    }

    // El ping ahora es informativo, indica a qu칠 host le est치s hablando
    function pingServer(url) {
        if (url !== activeHost) {
            render(`>>> AVISO: Est치s conectado a ${activeHost}. Para pinguear ${url} primero pulsa LINK.`, "sys");
            return;
        }
        render(`>>> PING ENVIADO A ${activeHost}...`, "sys");
        socket.send(`/date`);
        socket.send(`/way`);
    }

    function connectToServer(url) {
        if (url === activeHost && socket && socket.readyState === WebSocket.OPEN) {
            render(">>> YA EST츼S CONECTADO A ESTE NODO", "sys");
            return;
        }
        
        // Actualizamos el Host Activo para que sea el nuevo predeterminado
        activeHost = url; 
        render(`>>> CAMBIANDO DESTINO PREDETERMINADO A: ${activeHost}`, "sys");
        
        // Cerramos la conexi칩n actual; el evento onclose disparar치 conectar() con el nuevo activeHost
        if (socket) {
            socket.onclose = null; // Evitamos el disparo doble del reintento antiguo
            socket.close();
        }
        conectar(activeHost);
    }

    function parseServers(text) {
        const lines = text.split('\n');
        let htmlResponse = "";
        const originalHost = window.location.hostname;

        lines.forEach(line => {
            const cleanLine = line.trim();
            // Buscamos si la l칤nea contiene una URL
            const match = cleanLine.match(/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}/);
            
            if (match) {
                const url = match[0];
                const isCurrent = (url === activeHost);
                const isHostOrigin = (url === originalHost);
                
                let label = isHostOrigin ? "[ORIGEN]" : "[REMOTO]";
                if (isCurrent) label = "[ACTIVO]";

                htmlResponse += `
                <div class="server-line" style="${isCurrent ? 'border-left-color: #ffff00; background: #111;' : ''}">
                    <span class="server-url">${url}</span>
                    <span class="server-info" style="${isCurrent ? 'color: #0f0;' : ''}">${label}</span>
                    <div class="server-actions">
                        <button class="srv-btn ping-btn" onclick="pingServer('${url}')">PING</button>
                        <button class="srv-btn" onclick="connectToServer('${url}')">${isCurrent ? 'RECONECTAR' : 'LINK'}</button>
                    </div>
                </div>`;
            } else if (cleanLine !== "") {
                htmlResponse += `<div>${line}</div>`;
            }
        });
        return htmlResponse;
    }

    function render(text, type = 'server') {
        if (type === 'server' && lastCommandSent === "/servers") {
            const parsedHTML = parseServers(text);
            history.push({text: parsedHTML, type: 'server_html'});
            renderToDOM(parsedHTML, 'server_html');
            lastCommandSent = ""; 
            return;
        }

        if (type !== 'server' || text.startsWith("/") || text.includes("游닠") || text.includes(">>>")) {
            lastServerMsgDiv = null; 
            history.push({text, type});
            renderToDOM(text, type);
            return;
        }

        if (lastServerMsgDiv && type === 'server') {
            history[history.length - 1].text += text;
            updateDOM(lastServerMsgDiv, history[history.length - 1].text);
        } else {
            history.push({text, type});
            lastServerMsgDiv = renderToDOM(text, type);
        }

        if (text.includes("\n")) lastServerMsgDiv = null;
    }

    function renderToDOM(text, type) {
        const div = document.createElement('div');
        div.className = 'msg ' + (type === 'server_html' ? 'server' : type);
        updateDOM(div, text, type);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    function updateDOM(div, text, type = 'server') {
        if (type === 'server_html') {
            div.innerHTML = text;
        } else if (type === 'server') {
            if (currentMode === 'md') div.innerHTML = marked.parse(text);
            else if (currentMode === 'html') div.innerHTML = text;
            else div.textContent = text;
        } else {
            div.textContent = text;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function conectar(targetHost) {
        // Si no se pasa host, usamos el activo (por defecto el de la URL)
        const host = targetHost || activeHost;
        
        // Limpiamos cualquier timer de reconexi칩n previo
        if (reconnectTimer) clearTimeout(reconnectTimer);

        socket = new WebSocket('wss://' + host + '/ws/');
        
        socket.onopen = () => { 
            render(">>> ENLACE ESTABLECIDO CON: " + host, "sys"); 
        };

        socket.onmessage = (e) => { 
            if (e.data.length > 0) render(e.data, "server"); 
        };

        socket.onclose = () => { 
            render(`>>> CONEXI칍N PERDIDA EN ${activeHost} - REINTENTANDO...`, "sys");
            reconnectTimer = setTimeout(() => conectar(activeHost), reconnectInterval); 
        };

        socket.onerror = (err) => { 
            render(">>> ERROR DE NODO EN " + host, "sys"); 
        };
    }

    function enviarMensaje(e) {
        if(e) e.preventDefault();
        const msg = messageInput.value.trim();
        if (msg && socket && socket.readyState === WebSocket.OPEN) {
            lastCommandSent = msg;
            socket.send(msg);
            render("T칔: " + msg, "user");
            messageInput.value = "";
        }
        return false;
    }

    render(">>> ESCRIBIR /help Para Ayuda", "sys");
    // Iniciamos la primera conexi칩n con el host de la ventana
    conectar(activeHost);
</script>
</body>
</html>