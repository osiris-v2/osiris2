<?php
function makecard($params = []) {
    $defaults = [
        "title"       => "Mi Sitio Web",
        "description" => "Bienvenido a mi p√°gina personal.",
        "image"       => "https://tusitio.com/default-image.jpg",
        "url"         => (isset($_SERVER['HTTPS']) ? "https" : "http") . "://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]",
        "site_name"   => "Mi Marca",
        "twitter_id"  => "@tu_usuario",
        "card_type"   => "summary_large_image"
    ];
    $card = array_merge($defaults, $params);
    $html = "\n";
    $html .= '<meta property="og:type" content="website">' . "\n";
    $html .= '<meta property="og:url" content="' . htmlspecialchars($card['url']) . '">' . "\n";
    $html .= '<meta property="og:title" content="' . htmlspecialchars($card['title']) . '">' . "\n";
    $html .= '<meta property="og:description" content="' . htmlspecialchars($card['description']) . '">' . "\n";
    $html .= '<meta property="og:image" content="' . htmlspecialchars($card['image']) . '">' . "\n";
    $html .= '<meta property="og:site_name" content="' . htmlspecialchars($card['site_name']) . '">' . "\n";
    $html .= '<meta name="twitter:card" content="' . htmlspecialchars($card['card_type']) . '">' . "\n";
    $html .= '<meta name="twitter:title" content="' . htmlspecialchars($card['title']) . '">' . "\n";
    $html .= '<meta name="twitter:description" content="' . htmlspecialchars($card['description']) . '">' . "\n";
    $html .= '<meta name="twitter:image" content="' . htmlspecialchars($card['image']) . '">' . "\n";
    return $html;
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <?php 
    echo makecard([
        "title" => "Goyim Nation of Goys",
        "description" => "Goym World United",
        "image" => "https://goyimz.duckdns.org/img/goyimzh.png"
    ]);
    ?>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { background: #000000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding:0; }
        #wrapper { width: 90%; max-width: 600px; text-align: center; }
        
        .view-modes { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 5px; }
        .mode-btn { background: none; border: 1px solid #333; color: #555; font-size: 0.7em; cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: 0.3s; }
        .mode-btn:hover { color: #0f0; border-color: #0f0; }
        .mode-btn.active { color: #0f0; border-color: #0f0; background: #052505; }

        #chat-box { background: #0a0a0a; border: 1px solid #333; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; text-align: left; border-radius: 5px; }
        
        .msg { margin-bottom: 8px; border-bottom: 1px dashed #111; padding-bottom: 4px; white-space: pre-wrap; word-wrap: break-word; }
        .msg a { color: #ffff00; text-decoration: underline; font-weight: bold; } /* Color de enlaces */
        .msg a:hover { color: #fff; background: #444000; }

        .server { color: #0f0; }
        .user { color: #ccc; }
        .sys { color: #555; font-size: 0.8em; }

        #chat-form { display: flex; gap: 5px; }
        input { flex-grow: 1; background: #111; border: 1px solid #333; color: #0f0; padding: 10px; }
        button#send-btn { background: #0f0; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }

        /* Estilos del Desplegable de Comandos */
        #command-drawer { width: 100%; margin-top: 5px; }
        .drawer-btn { background: none; border: 1px solid #222; color: #444; font-size: 0.7em; cursor: pointer; padding: 4px; width: 100%; border-radius: 3px; }
        #quick-commands { display: none; flex-wrap: wrap; gap: 5px; padding: 10px; background: #050505; border: 1px solid #222; margin-top: -1px; }
        #quick-commands button { background: #111; border: 1px solid #333; color: #0c0; font-size: 0.75em; padding: 4px 8px; cursor: pointer; }
        #quick-commands button:hover { background: #0f0; color: #000; }
        .show { display: flex !important; }
    </style>
</head>
<body>

<div id="wrapper">
    <img src="img/goyimzh.png" style="max-width:100%;max-height:140px; margin-bottom:17px;">
    
    <div class="view-modes">
        <button class="mode-btn active" onclick="setMode('text', this)">TEXT</button>
        <button class="mode-btn" onclick="setMode('md', this)">MD</button>
        <button class="mode-btn" onclick="setMode('html', this)">HTML</button>
    </div>

    <div id="chat-box"></div>

    <form id="chat-form" onsubmit="enviarMensaje(event); return false;">
        <input type="text" id="message-input" placeholder="Comando..." required autocomplete="off">
        <button type="submit" id="send-btn">></button>
    </form>

    <div id="command-drawer">
        <button class="drawer-btn" onclick="toggleDrawer()">[+] COMANDOS R√ÅPIDOS</button>
        <div id="quick-commands">
            <button onclick="cmdRapido('/help')">/help</button>
            <button onclick="cmdRapido('/listtv')">/listtv</button>
            <button onclick="cmdRapido('/servers')">/servers</button>
            <button onclick="cmdRapido('/date')">/date</button>
            <button onclick="cmdRapido('/way')">/way</button>
            <button onclick="cmdRapido('/models')">/models</button>
            <button onclick="cmdRapido('/limit')">/limit</button>
            <button onclick="cmdRapido('/stop')">/stop</button>
            <button onclick="cmdRapido('/clearcontext')">/clearcontext</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    let socket;
    let currentMode = 'text';
    let history = []; // Historial para re-renderizar
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    let reconnectInterval = 3000;
    let lastServerMsgDiv = null; // Para saber si estamos en medio de un streaming

    // Configuraci√≥n de Marked para abrir enlaces en blanco
    marked.use({
        renderer: {
            link(href, title, text) {
                return `<a target="_blank" href="${href}">${text}</a>`;
            }
        }
    });

    function toggleDrawer() {
        document.getElementById('quick-commands').classList.toggle('show');
    }

    function cmdRapido(cmd) {
        messageInput.value = cmd;
        enviarMensaje();
        //toggleDrawer();
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        refreshChat();
    }

    function refreshChat() {
        chatBox.innerHTML = "";
        history.forEach(m => renderToDOM(m.text, m.type));
    }

function render(text, type = 'server') {
        // Si es un comando o un mensaje de usuario, no es streaming
        if (type !== 'server' || text.startsWith("/") || text.includes("üì∫") || text.includes(">>>")) {
            lastServerMsgDiv = null; 
            history.push({text, type});
            renderToDOM(text, type);
            return;
        }

        // Si es streaming de la IA
        if (lastServerMsgDiv && type === 'server') {
            // Buscamos el √∫ltimo objeto en el historial para actualizar su texto
            history[history.length - 1].text += text;
            updateDOM(lastServerMsgDiv, history[history.length - 1].text);
        } else {
            // Es el primer token de una respuesta nueva
            history.push({text, type});
            lastServerMsgDiv = renderToDOM(text, type);
        }

        // Si la IA manda un salto de l√≠nea final, cerramos el bloque de streaming
        if (text.includes("\n")) {
            lastServerMsgDiv = null;
        }
    }

    function renderToDOM(text, type) {
        const div = document.createElement('div');
        div.className = 'msg ' + type;
        updateDOM(div, text, type);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div; // Devolvemos el div para poder seguir escribiendo en √©l
    }

    function updateDOM(div, text, type = 'server') {
        if (type === 'server') {
            if (currentMode === 'md') div.innerHTML = marked.parse(text);
            else if (currentMode === 'html') div.innerHTML = text;
            else div.textContent = text;
        } else {
            div.textContent = text;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function conectar() {
        socket = new WebSocket('wss://'+window.location.hostname+'/ws/');
        socket.onopen = () => { render(">>> ENLACE ESTABLECIDO", "sys"); };
        socket.onmessage = (e) => { if (e.data.length > 0) render(e.data, "server"); };
        socket.onclose = () => { 
            render(">>> CONEXI√ìN PERDIDA - REINTENTANDO", "sys");
            setTimeout(conectar, reconnectInterval); 
        };
        socket.onerror = () => { render(">>> ERROR DE NODO", "sys"); };
    }

    function enviarMensaje(e) {
        if(e) e.preventDefault();
        const msg = messageInput.value.trim();
        if (msg && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(msg);
            render("T√ö: " + msg, "user");
            messageInput.value = "";
        }
        return false;
    }

    render(">>> ESCRIBIR /help Para Ayuda", "sys");
    conectar();
</script>
</body>
</html>